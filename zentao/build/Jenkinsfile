import hudson.model.*;

println env.JENKINS_HOME
println env.JOB_NAME
println env.BUILD_NUMBER

pipeline {
    agent { node { label 'build-server' } }
    stages {
        stage("init") {
            steps{
                script{
                    model_test = load "utils.groovy"
                }
            }
        }
        stage("read yaml file") {
            steps{
                script{
                    yaml_file = "conf.yml"
                    conf = model_test.read_yaml_file(yaml_file)
                }
            }
        }

	    stage('build image') {
		    steps {
		    	dir ('zentao/build') {
			        script {
			            echo 'download tools'
			            sh 'wget -P tool http://${ARTIFACTORY_JCR_SERVER}/${TOOLS_PATH}/yuicompressor.jar'

			            echo 'build docker image ...'
			            sh 'docker build \
			                --build-arg  ARTIFACTORY_USER=${ARTIFACTORY_USER} \
			                --build-arg  ARTIFACTORY_PASSWORD=${ARTIFACTORY_PASSWORD} \
			                --rm -t ${IMAGE_NAME} .'
			        }
		        }
		    }
	    }
	    stage('push image') {
			steps {
                echo 'upload docker image ...'

                sh 'docker login -u ${ARTIFACTORY_USER} -p ${ARTIFACTORY_PASSWORD} ${ARTIFACTORY_JCR_SERVER}'
                sh 'docker push ${IMAGE_NAME}'
			}
	    }
	}
}
