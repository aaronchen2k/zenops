pipeline {
    agent none
    stages {
	    stage('build image') {
	    	agent { node { label 'pve' } }
		    steps {
		    	dir ('zentao/build') {
			        script {
			            echo 'download tools'
			            sh 'wget -P tool http://192.168.1.161:58082/artifactory/zentaopms/tool/yuicompressor.jar'

			            echo 'build docker image ...'
			            sh 'docker build --rm -t 192.168.1.161:59082/zenops/zentao-builder:latest .'
			        }
		        }
		    }
	    }
	    stage('push image') {
		    agent { node { label 'pve' } }
			steps {
                echo 'upload docker image ...'

                sh 'docker login -u zenops-user -p P2ssw0rd 192.168.1.161:59082'
                sh 'docker push 192.168.1.161:59082/zenops/zentao-builder:latest'
			}
	    }
	    stage('start container to compile') {
            agent { node { label 'pve' } }
            steps {
                echo 'start to compile'

                sh 'docker pull 192.168.1.161:59082/zenops/zentao-builder:latest'
                sh 'docker rm -f zentao-builder'
                sh 'docker run -d --name zentao-builder 192.168.1.161:59082/zenops/zentao-builder:latest'
            }
        }
	}
}
